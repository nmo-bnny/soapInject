Intro

This attack was documented solely for research purposes.
This document was created to evaluate the penetration resistance of the Linksys (Cisco) Router, Model WRT150N, and serves as a checkpoint for my first officially documented penetration test.
This lab I made for myself was tested on devices I own and I advise readers to practice the actions learned here, ethically and
for the greater good.

Software Used

sudo apt install gssdp
sudo apt install gupnp-tools
sudo apt install python
sudo apt install minicom
sudo apt install nmap

Hardware Used

UART Metal Pins
Female to Female UART Adapter Cables
USB/UART Adapter (With Male Pins)
Multimeter
Computer Screwdriver Kit
IFixit Wedges (Blue)
Soldering Iron
Flux
Copper Solder Sponge
Fan
Gas Mask
Linux OS (Laptop)

Target:
Linksys Router(Cisco) Model: WRT150N

Firmware:
v1.00.5 Nov. 23, 2006

4MB flash and 16MB RAM.






First Thoughts:

The router’s network infrastructure presents several security concerns. The current configuration relies on multiple outdated services, employs improper encryption during initial setup,
and exposes an administrative web interface operating over port 80 (HTTP).


Additionally, WPS can be enabled to simplify client connections;
however, this feature introduces a known security risk.
WPS implementations, particularly on older devices—are vulnerable to brute-force attacks against the WPS PIN mechanism.
The physical WPS button places the router into a temporary pairing state, which, if abused, could allow unauthorized devices to connect to the network.







Reconnaissance 

An NMAP scan of the router's ports can give us a peak, at some of the services running on the device.

Services
- 443 (HTTPS)
- 80 (HTTP)(Webserver)



Poking Around:

I decided to connect to the most inviting port (port 80), I logged into the admin console using the default
credentials "admin" for both the username and password. Upon entry I was met with the routers admin UI that allowed for 
security configurations and other general networking settings.

I found that port services can be manually enabled through the settings for easy setup.
The most worrisome service being UPNP. I decided to turn this option on as it seems like the most exploitable.
I ran another scan and it shows us that UPNP is running on an uncommonly used port under the 
service name -park-agent.

Services
- 5431/tcp open  park-agent

I decided to run a more in-depth scan using the -A flag to increase my understanding of the service.

Services
- 5431/tcp open  tcpwrapped
- |_unusual-port: tcpwrapped unexpected on port tcp/5431

A rule has been set to prevent Nmap from fingerprinting the service.


After adding the -f (fragment) flag to bypass, we get,

5431/tcp open  upnp    Belkin/Linksys wireless router UPnP (UPnP 1.0; BRCM400 1.0)

We now know the UPNP service is definitely on this port and it is a running on an older version (UPnP 1.0).






Research:

Documentation online mentions multiple vulnerabilities in Linksys routers.
One of these being the legendary "Moon Worm" exploit a remote injection attack
that exploits the following files.

tmUnBlock.cgi
tmBlock.cgi
hndUnblock.cgi
hndBlock.cgi


With this knowledge, I attempted to use Routersploit as part of a controlled security assessment,
but encountered repeated failures with the payload execution.

I decided to manually contact all of the files mentioned but it all resulted in a 404. 

The writer left us a note.


"Based on "strings" output on The Moon worm binary, the
following devices may be vulnerable.  This list may not be
accurate and/or complete!!! 


Supposedly Affected Models
..
WRT400N
WRT320N
WRT160N
WRT150N
..
"





Deep Dive Into The UPNP protocol


I was unsuccessful with the pre-made exploits,
so I decided to manually investigate and manipulate the UPnP service.


The UPNP protocol can be communicated with through a variety of tools

Tools:



miniupnpc: A utility that allows for the manipulation and retrieval of detailed information about the UPnP service.

gupnp: It provides a framework for discovering and interacting with UPnP devices and services using protocols like SSDP and SOAP

gssdp-discover: A tool designed for discovering UPnP devices and collecting metadata through SSDP (Simple Service Discovery Protocol).


How to install:

sudo apt install libgupnp-1.0-0 libgupnp-1.0-dev gupnp-tools
sudo apt install miniupnpc 
sudo apt install gssdp



Lets begin by using miniupnpc

The UPNP service failed to respond to the miniupnpc tool.

The miniupnpc tool requires a standard UPnP configuration to function properly.
It can only operate successfully if the target service is running on port 9100
(the default UPnP port) and if specific conditions are met during the transaction phase.


Instead... 

I used the GUPnP Tool for custom setups (park-agent, port 5431).

Testing with GUPNP Tool

I start the tool by running gupnp-universal-cp, this displays a UI that we can use to send basic commands to the modules on the router,
this can be anything from changing the routers password to opening ports on the router. The GUPNP tool gets these module selections
by analyzing an XML file given through the UPNP service on the router.

To manually see this XML file we can use the gssdp-discover tool, and run this command.

gssdp-discover --target upnp:rootdevice

This let's us view the modules on the device through the XML file.
We can then search for these modules online to understand what they
actually do.


After running the command we receive a link from the service, if we follow this link,
we are shown the XML page listing all modules. The link should look like the one below.


http://192.168.1.1:5431/dyndev/uuid:0018-f8d7-a07100009adc


- Note -
The XML file for this penetration test can be found in the same folder as this document


A couple interesting modules extracted from the XML file are shown below.

XML Output Section

<serviceType>urn:schemas-upnp-org:service:WANIPConnection:1</serviceType>
<serviceType>urn:schemas-upnp-org:service:WANPPPConnection:1</serviceType>


The modules shown above caught my eye, as they are referenced in a
small vulnerability report done on a similar model.


The researcher of the report mentioned


" The vulnerability present in the SetConnectionType function of wanipc and wanappp modules
can be reached with a single SOAP request that calls the SetConnectionType function "


In this excerpt, the researcher is referencing a format string vulnerability that allows
for arbitrary values to be remotely read and written into arbitrary memory addresses.

Meaning we can potentially execute commands remotely. 
This specific attack takes advantage of how the program interprets the data.


This is great news for us, as our target service is potentially vulnerable to this attack.
The researcher also added snippets of their XML docs and we can see they are running the same version of UPNP on their similar device.






SOAP and UPNP


GUPNP is a useful tool as it allows us to send SOAP packets to the UPNP service.
Using this we can configure the router remotely, and bypass firewall rules.
In these following snippets I test simple commands on target port 5431.

To run it use this command

gupnp-universal-cp

We can now send a SOAP command that attempts to open port 22 (It is closed as of now),
we can view the response on Wireshark.


Frame 12: 355 bytes on wire (2840 bits), 355 bytes captured (2840 bits) on interface, id 0
Ethernet II, Src: ---- (MAC), Dst: ChongqingFug_---- (MAC)
Internet Protocol Version 4, Src: 192.168.1.1, Dst: 192.168.1.2
Transmission Control Protocol, Src Port: 5431, Dst Port: 49514, Seq: 189, Ack: 956, Len: 289
[2 Reassembled TCP Segments (477 bytes): #10(188), #12(289)]
Hypertext Transfer Protocol
eXtensible Markup Language
    <?xml
        version="1.0"
        ?>
    <s:Envelope
        xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"
        s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/">
        <s:Body>
            <m:AddPortMappingResponse
                xmlns:m="urn:schemas-upnp-org:service:WANIPConnection:1">
                </m:AddPortMappingResponse>
            </s:Body>
    </s:Envelope>



The SOAP packet above should be received by the router and attempt to make those changes,
once done, we should receive a 200 status code. I send it and get the 200 code.

I rescan open ports.

Nmap Scan Results

PORT     STATE    SERVICE
21/tcp   filtered ftp
22/tcp   filtered ssh
80/tcp   open     http
443/tcp  open     https
5431/tcp open     park-agent

As we can see the SOAP packet sent modified the firewall rules and now allows for some contact.
I attempted to open port 21 and again succeeded.

Attempting to connect to these ports led to failure as services like OpenSSH are most likely not running
on the system, this means there is nothing to catch our connection attempts.

In this specific scenario no services were running on the system had OpenSSH been installed, I as an attacker could have easily bypassed the firewall
and brute forced an ssh password potentially getting remote access to the router.

I decided to change something visual on the system using the tool.
I ran the GetUsername command (with update) and sent the SOAP message with username set to "Bunny".
I received a 200 message (success).

To confirm my changes I ran the GetUsername command (without update) and I received the following response.

<NewUserName>
   Bunny
</NewUserName>

I successfully updated the username remotely to "Bunny".
A similar process was done to change the password, all this was done through UPNP and the SOAP protocol.



Small Win

We modified system values, punched holes through the firewall, and used SOAP to change login credentials, this ultimately lets us know the the router is not secure
and can be easily compromised if the UPNP service is on. 

- Note -
While this service is not on by default most users fail to change their default credentials, if someone can connect to the network,
it is a very simple guessing game between safety and a complete takeover.





Probing Modules

Before moving on clarification is needed for the wanapp and winipc modules, these modules (mentioned earlier in this section), are both vulnerable to remote attacks.
The wanapp module is vulnerable because it allows us to send commands to the target device, without validating who we are.
The wanipc is vulnerable because it contains a format string vulnerability in the SetConnectionType function.


Now that we know our SOAP commands can modify system values and the vulnerable functions have been found in the XML Module Share,
we can begin sending customized packets to the target modules.

We will be using the requests library in python and the GUPNP tool for initializing the connection with the target.

- Note -
We cannot use GUPNP for the injection as the tool is made for legitimate uses,
so you cannot easily plug in custom values, so we need to use of a custom python script.
This python script is in the same folder as this document. Please use it carefully and do not
test on systems you do not own.



According to the report  
"The SetConnectionType function of wanipc and wanppp modules can be reached with a single SOAP request that calls SetConnectionType function."
The SetConnectionType will be the target function that we will contact and where we will attempt to insert the specifier %p to test if the vulnerability exists on our router.



Before tackling the target function we must see if our custom py script correctly contacts the UPNP service.
The script created uses the requests python library to send a structured SOAP message to the target.

Attempting to send the custom packet failed multiple times.
I tweaked the headers and finally found the right structure.


Example of Functioning Header (tells UPNP service how to interpret my packet)

headers = {
    "Content-Type": "text/xml; charset=\"utf-8\"",
    "SOAPAction": "\"urn:schemas-upnp-org:service:WANPPPConnection:1#GetStat>
}


Example of Functioning URL
url                port                             valid path
http://{target_ip}:5431/uuid:0018-f8d7-a07102009adc/WANPPPConnection:1



This SOAP structure and URL can be grabbed by viewing traffic (Wireshark)
between you and the target or you can just download the XML with the tool discussed earlier.

Awesome! we get a 200 (success) response!
This means we successfully sent a normal command with our custom script and received a response!

We can now modify our XML structure to focus on our target function.


- Note -
Be careful in this upcoming section a small mistake can crash the UPNP service, while its not a critical crash,
the full extent of damage created by sending conflicting values is unknown!


The target service we want is :WANIPConnection with the target function being SetConnectionType. 

I set this using my script and set the identifier %p, as the payload, I send it out.
A perfect 200(success).


If we call the GetConnectionTypeInfo module we can see a memory address!


Response:
<NewConnectionType>
    0x7fff7b60
</NewConnectionType>


This is significant because it indicates the presence of a string vulnerability,
which allows for further exploitation.


This confirms the vulnerability exists on this model, and we could potentially send a payload
that matches the architecture of the device, catch a shell, and get remote access to the device. 



Hardware Hacking UART

We found many software bugs that could lead to successful remote attacks, but I wanted to test physical
security. The following is the process I created and followed.


The Plan
We will be soldering off the UART pads on the circuit board added to keep us from tampering with the device 
and adding male UART pins in its place, after this is done we will be able to add female cables to the male ports 
and connect that to a USB/UART adapter. We will then use minicom to view data on the device.

The Steps
First we need to remove the plastic case from the router, I used a computer screwdriver set and an IFixit wedge tool often used to remove screens from phones.
The case should come off easily (do not force, grab firmly) remove screwdrivers hidden under the casing. Once you get the circuit board completely out, you should see the UART ports.

Begin heating your soldering iron and set up your workstation, clean your workstation so it is free of residues (I used isopropyl alcohol), place a fan with a light breeze to blow metal fumes away
from you, and for extra precaution wear a gas mask (I used a 3M 6200) to avoid sniffing lead. I highly recommend doing this outside.

When everything is set add some flux to the pads, and lay your copper sponge on top of the flux, place your iron tip on top of the copper sponge for a couple seconds and the 
metal should get sucked up by the copper sponge. Repeat for all ports, till completely cleaned.

After that just slide the UART pins through the holes and solder the underside with soldering wire to the circuit board.

That allows us to connect using our cables and USB/UART adapter.


Getting A Shell
Once physically connected I used minicom to connect to the router.

sudo minicom -D /dev/ttyUSB0

The command above connected me to the router directly. No Authentication Required.



Conclusion

The WRT150N Linksys Router is now confirmed to indeed have this string format vulnerability and a no-auth UPNP setup.

We managed to
- Punch holes through the firewall using UPNP and SOAP
- Inject specifiers through the string vulnerability located on a specific module
- Hardware hack our way in through padded UART ports.
- Managed to crash the UPNP service remotely

While this system is over 15 years old it gives us insight into how easy an attacker can take control of a system.
It is important to understand many devices on corporate networks often run outdated software and can be easily taken over!

Devices running this software are NOT limited to a specific time period,
as of 2025 from my own research other devices are running similar vulnerable
modules.

These instances have not been marked as CVE's, and have been mostly reported by lone researchers.
So far I have found two reports that mention TP-Link and Linksys Routers.

An attacker with a compromised router can monitor traffic, attack devices within the network,
and attack other connected networks. Opening the door for more malware, ransomware attacks, and identity theft.


This was a fun project I hope you enjoyed my walk through!





Things I learned

I learned about both UPNP and SOAP protocols.
I learned basic soldering.
I learned more about UART ports.
I learned about format injections.
I learned that these exploits can be used to manipulate memory and registry spaces.
I learned that UPNP is valuable to attackers as it can bypass firewalls and communicate with internal services.
I learned more about the ecosystem of embedded devices.




References Used


General Search
- Chatgpt
--( Any AI Model Can Be Used For General Questions )



Information
- Injecting Specifiers
--https://cs155.stanford.edu/papers/formatstring-1.2.pdf
- SOAP Vuln
--https://www.helpnetsecurity.com/2013/01/31/high-risk-broadcom-upnp-stack-remote-root-vulnerability/
- Moonworm
--https://www.exploit-db.com/exploits/31683


Drop a star if you found this cool :)




